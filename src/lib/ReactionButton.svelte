<script lang="ts">
	import { spawnPowSolveWorker } from '$lib/pow-solve.js';
	import { Spring } from 'svelte/motion';

	let {
		reaction,
		value,
		onclick,
		onreact
	}: {
		reaction: string;
		value: number;
		onclick: () => Promise<{ challenge: string }>;
		onreact: ({
			challenge,
			solutions
		}: {
			challenge: string;
			solutions: number[];
		}) => Promise<void>;
	} = $props();

	let clicked = $state(false);
	let progress = new Spring(0, {
		stiffness: 0.05,
		damping: 0.3
	});
</script>

<div class="flex items-center flex-col gap-1">
	<div class="relative">
		<button
			class={[
				'rounded-full transition-colors focus:outline-0 inline-block text-2xl w-10 h-10 cursor-pointer relative z-[1] disabled:cursor-progress',
				{
					'hover:bg-black/10 focus-visible:bg-black/10 dark:hover:bg-neutral-500/10 dark:focus-visible:bg-neutral-500/10':
						!clicked
				}
			]}
			disabled={clicked}
			onclick={async () => {
				if (clicked) return;
				progress.set(0.1, {
					instant: true
				});
				clicked = true;
				try {
					const { challenge } = await onclick();
					const solutions = await spawnPowSolveWorker({
						challenge,
						onprogress: (p) => progress.set(0.1 + p * 0.9)
					});
					await Promise.all([
						onreact({ challenge, solutions }),
						new Promise((r) => setTimeout(r, 200))
					]);
				} finally {
					clicked = false;
				}
			}}
		>
			{reaction}
		</button>
		<div
			class={[
				'progress absolute top-0 left-0 w-full h-full rounded-full transition-opacity duration-200 from-black/10 dark:from-neutral-500/10',
				{
					'opacity-100 ': clicked,
					'opacity-0': !clicked
				}
			]}
			style="--progress: {Math.round(progress.current * 100)}%"
		></div>
	</div>
	<span class="text-black/60 text-sm font-medium dark:text-neutral-300/60">
		{value}
	</span>
</div>

<style>
	.progress {
		background: conic-gradient(var(--tw-gradient-from) var(--progress), transparent 0deg);
	}
</style>
